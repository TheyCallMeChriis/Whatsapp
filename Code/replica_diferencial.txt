from datetime import datetime, timedelta
import pyodbc
import mysql.connector

# -----------------------------------------
# CONEXI√ìN A SQL SERVER (AUTENTICACI√ìN WINDOWS)
# -----------------------------------------
try:
    sql_conn = pyodbc.connect(
        "DRIVER={ODBC Driver 17 for SQL Server};"
        "SERVER=localhost;"
        "DATABASE=MensajeriaBD;"
        "Trusted_Connection=yes"
    )
    sql_cursor = sql_conn.cursor()
    print("‚úÖ Conectado a SQL Server.")
except Exception as e:
    print("‚ùå Error al conectar con SQL Server:", e)
    exit()

# -----------------------------------------
# CONEXI√ìN A MYSQL
# -----------------------------------------
try:
    mysql_conn = mysql.connector.connect(
        host="localhost",
        user="root",
        password="27186627",
        database="MensajeriaReplica"
    )
    mysql_cursor = mysql_conn.cursor()
    print("‚úÖ Conectado a MySQL.")
except Exception as e:
    print("‚ùå Error al conectar con MySQL:", e)
    sql_conn.close()
    exit()

# -----------------------------------------
# REPLICACI√ìN DIFERENCIAL
# -----------------------------------------

try:
    un_minuto_atras = datetime.now() - timedelta(minutes=1)

    # USUARIOS modificados en el √∫ltimo minuto
    sql_cursor.execute(
        "SELECT id, nombre, correo, contrasena, actualizado FROM Usuarios WHERE actualizado >= ?",
        (un_minuto_atras,)
    )
    usuarios = sql_cursor.fetchall()
    for row in usuarios:
        mysql_cursor.execute("""
            INSERT INTO Usuarios (id, nombre, correo, contrasena, actualizado)
            VALUES (%s, %s, %s, %s, %s)
            ON DUPLICATE KEY UPDATE
                nombre = VALUES(nombre),
                correo = VALUES(correo),
                contrasena = VALUES(contrasena),
                actualizado = VALUES(actualizado)
        """, row)
    print(f"üë§ {len(usuarios)} usuarios actualizados.")

    # MENSAJES modificados en el √∫ltimo minuto
    sql_cursor.execute(
        "SELECT id, emisor_id, receptor_id, contenido, fecha_envio, actualizado FROM Mensajes WHERE actualizado >= ?",
        (un_minuto_atras,)
    )
    mensajes = sql_cursor.fetchall()
    for row in mensajes:
        mysql_cursor.execute("""
            INSERT INTO Mensajes (id, emisor_id, receptor_id, contenido, fecha_envio, actualizado)
            VALUES (%s, %s, %s, %s, %s, %s)
            ON DUPLICATE KEY UPDATE
                contenido = VALUES(contenido),
                fecha_envio = VALUES(fecha_envio),
                actualizado = VALUES(actualizado)
        """, row)
    print(f"üí¨ {len(mensajes)} mensajes actualizados.")

    mysql_conn.commit()
    print("‚úÖ Replicaci√≥n diferencial realizada con √©xito.")

except Exception as e:
    print("‚ùå Error durante la replicaci√≥n:", e)

# -----------------------------------------
# CERRAR CONEXIONES
# -----------------------------------------
sql_conn.close()
mysql_conn.close()
print("üîí Conexiones cerradas.")
